#
# DO NOT EDIT THIS FILE DIRECTLY - UNLESS YOU KNOW WHAT YOU ARE DOING
#

user node[:streamingbenchmarks][:user] do
  action :create
  supports :manage_home => true
  home "/home/#{node[:streamingbenchmarks][:user]}"
  shell "/bin/bash"
  not_if "getent passwd #{node[:streamingbenchmarks]['user']}"
end

private_ip = my_private_ip()
public_ip = my_public_ip()


package "git" do 
  action :install
end

package "maven" do 
  action :install
end


# Pre-Experiment Code


# Configuration Files

directory "#{node[:streamingbenchmarks][:home]}" do
  owner node[:streamingbenchmarks][:user]
  group node[:streamingbenchmarks][:group]
  mode "755"
  action :create
  recursive true
  not_if { File.directory?("#{node[:streamingbenchmarks][:home]}") }
end


for d in %w[ Test Test/data conf src bin ] do
  directory "#{node[:streamingbenchmarks][:home]}/#{d}" do
    owner node[:streamingbenchmarks][:user]
    group node[:streamingbenchmarks][:group]
    mode "755"
    action :create
    not_if { File.directory?("#{node[:streamingbenchmarks][:home]}/#{d}") }
  end
end
  
remote_file "#{node[:streamingbenchmarks][:home]}/Test/data/tweets.txt"  do
  source "http://snurran.sics.se/hops/tweets.txt"
  checksum "4db5026349dd57febf4a68d56b7f1a2769df4eb6bd6b44a8155fe56f551903f7"
  mode 0755
  action :create
end

bench="intel-benchmarks.tgz"
bench_src="intel-benchmarks-src.tgz"

remote_file "/tmp/#{bench}"  do
  source "http://snurran.sics.se/hops/#{bench}"
  mode 0755
  action :create
end

remote_file "/tmp/#{bench_src}"  do
  source "http://snurran.sics.se/hops/#{bench_src}"
  mode 0755
  action :create
end


bash "unpack_intel_benchmarks" do
  user "root"
    code <<-EOF
set -e
cd /tmp
#    tar -xf #{bench_src} -C #{node[:streamingbenchmarks][:home]}/src   
     tar -xf #{bench} -C #{node[:streamingbenchmarks][:home]}/bin 
#    chown -R #{node['streamingbenchmarks']['user']} #{node[:streamingbenchmarks][:home]}/src   
    chown -R #{node['streamingbenchmarks']['user']} #{node[:streamingbenchmarks][:home]}/bin
touch #{node[:streamingbenchmarks][:home]}/.benchmarks_downloaded
EOF
  not_if { ::File.exists?( "#{node[:streamingbenchmarks][:home]}/.benchmarks_downloaded" ) }
end



